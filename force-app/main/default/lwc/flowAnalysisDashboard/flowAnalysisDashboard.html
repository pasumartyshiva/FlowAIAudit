<template>
    <lightning-card title="Flow AI Audit Dashboard" icon-name="custom:custom63">
        <!-- Header Section with Summary Cards -->
        <div slot="actions">
            <lightning-button-icon
                icon-name="utility:info"
                variant="border-filled"
                alternative-text="Help"
                title="Quick Start Guide"
                onclick={handleOpenHelp}
                class="slds-m-right_x-small"
            ></lightning-button-icon>
            <lightning-button
                label="Fetch All Flows"
                onclick={handleRunAllFlows}
                variant="brand"
                disabled={isLoading}
                icon-name="utility:refresh"
            ></lightning-button>
            <lightning-button
                label="Analyze Selected (Max 5)"
                onclick={handleAnalyzeSelected}
                variant="success"
                icon-name="utility:play"
                disabled={hasNoSelection}
                class="slds-m-left_x-small"
                title="Analyze up to 5 selected flows"
            ></lightning-button>
            <lightning-button
                label="Refresh"
                onclick={handleRefresh}
                variant="neutral"
                icon-name="utility:sync"
                class="slds-m-left_x-small"
            ></lightning-button>
            <lightning-button
                label="Delete Selected"
                icon-name="utility:delete"
                onclick={handleDeleteSelected}
                variant="destructive"
                disabled={hasNoSelection}
                class="slds-m-left_x-small"
            ></lightning-button>
            <lightning-button
                label="Delete All Records"
                icon-name="utility:delete"
                onclick={handleDeleteAll}
                variant="destructive-text"
                class="slds-m-left_x-small"
            ></lightning-button>
        </div>

        <!-- Batch Progress Bar -->
        <template if:true={showBatchProgress}>
            <div class="slds-box slds-theme_warning slds-m-around_small">
                <div class="slds-grid slds-gutters">
                    <div class="slds-col">
                        <lightning-icon
                            icon-name="utility:spinner"
                            size="small"
                            alternative-text="Processing"
                        ></lightning-icon>
                        <span class="slds-m-left_small">{batchProgressText}</span>
                    </div>
                </div>
            </div>
        </template>

        <!-- Summary Cards -->
        <div class="slds-m-around_medium">
            <div class="slds-grid slds-gutters slds-wrap">
                <!-- Pass Card -->
                <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3 slds-large-size_1-of-6">
                    <div class="summary-card slds-box slds-theme_success">
                        <div class="slds-text-heading_large">{passCount}</div>
                        <div class="slds-text-body_small">Pass</div>
                    </div>
                </div>

                <!-- Needs Work Card -->
                <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3 slds-large-size_1-of-6">
                    <div class="summary-card slds-box slds-theme_warning">
                        <div class="slds-text-heading_large">{needsWorkCount}</div>
                        <div class="slds-text-body_small">Needs Work</div>
                    </div>
                </div>

                <!-- Fail Card -->
                <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3 slds-large-size_1-of-6">
                    <div class="summary-card slds-box slds-theme_error">
                        <div class="slds-text-heading_large">{failCount}</div>
                        <div class="slds-text-body_small">Fail</div>
                    </div>
                </div>

                <!-- Pending Card -->
                <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3 slds-large-size_1-of-6">
                    <div class="summary-card slds-box slds-theme_shade">
                        <div class="slds-text-heading_large">{pendingCount}</div>
                        <div class="slds-text-body_small">Pending</div>
                    </div>
                </div>

                <!-- Analyzing Card -->
                <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3 slds-large-size_1-of-6">
                    <div class="summary-card slds-box slds-theme_info">
                        <div class="slds-text-heading_large">{analyzingCount}</div>
                        <div class="slds-text-body_small">Analyzing</div>
                    </div>
                </div>

                <!-- Total Card -->
                <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3 slds-large-size_1-of-6">
                    <div class="summary-card slds-box slds-theme_default">
                        <div class="slds-text-heading_large">{totalCount}</div>
                        <div class="slds-text-body_small">Total Flows</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="slds-m-around_medium">
            <div class="slds-grid slds-gutters">
                <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2">
                    <lightning-combobox
                        name="status"
                        label="Filter by Status"
                        value={selectedStatus}
                        options={statusOptions}
                        onchange={handleStatusChange}
                    ></lightning-combobox>
                </div>
                <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2">
                    <lightning-input
                        type="search"
                        label="Search Flows"
                        value={searchTerm}
                        onchange={handleSearchChange}
                        placeholder="Search by flow name..."
                    ></lightning-input>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="slds-m-around_medium">
            <template if:true={isLoadingSimple}>
                <lightning-spinner alternative-text="Loading" size="medium"></lightning-spinner>
            </template>

            <template if:true={hasFlows}>
                <!-- Table Controls -->
                <div class="slds-grid slds-gutters slds-m-bottom_small">
                    <div class="slds-col slds-size_1-of-2">
                        <div class="slds-text-body_small slds-text-color_weak">
                            Showing {startRecord} - {endRecord} of {totalRecords} flows
                        </div>
                    </div>
                    <div class="slds-col slds-size_1-of-2">
                        <div class="slds-float_right">
                            <lightning-button-group>
                                <lightning-button
                                    label="10"
                                    variant={pageSize10Variant}
                                    onclick={handlePageSize10}
                                ></lightning-button>
                                <lightning-button
                                    label="25"
                                    variant={pageSize25Variant}
                                    onclick={handlePageSize25}
                                ></lightning-button>
                                <lightning-button
                                    label="50"
                                    variant={pageSize50Variant}
                                    onclick={handlePageSize50}
                                ></lightning-button>
                                <lightning-button
                                    label="100"
                                    variant={pageSize100Variant}
                                    onclick={handlePageSize100}
                                ></lightning-button>
                            </lightning-button-group>
                        </div>
                    </div>
                </div>

                <!-- Flashy Custom Table -->
                <div class="fancy-table-container">
                    <table class="slds-table slds-table_cell-buffer slds-table_bordered slds-table_fixed-layout fancy-custom-table">
                        <thead>
                            <tr class="slds-line-height_reset">
                                <th class="slds-text-title_caps" scope="col" style="width: 5%;">
                                    <div class="slds-text-align_center">
                                        <lightning-input
                                            type="checkbox"
                                            onchange={handleSelectAll}
                                            checked={isAllSelected}
                                            variant="label-hidden"
                                            label="Select All"
                                        ></lightning-input>
                                    </div>
                                </th>
                                <th class="slds-text-title_caps" scope="col" style="width: 25%;">
                                    <div class="slds-truncate" title="Flow Name">Flow Name</div>
                                </th>
                                <th class="slds-text-title_caps" scope="col" style="width: 7%;">
                                    <div class="slds-truncate slds-text-align_center" title="Version">Version</div>
                                </th>
                                <th class="slds-text-title_caps" scope="col" style="width: 9%;">
                                    <div class="slds-truncate slds-text-align_center" title="Status">Status</div>
                                </th>
                                <th class="slds-text-title_caps" scope="col" style="width: 7%;">
                                    <div class="slds-truncate slds-text-align_center" title="Score">Score</div>
                                </th>
                                <th class="slds-text-title_caps" scope="col" style="width: 17%;">
                                    <div class="slds-truncate" title="Last Analyzed">Last Analyzed</div>
                                </th>
                                <th class="slds-text-title_caps" scope="col" style="width: 30%;">
                                    <div class="slds-truncate slds-text-align_center" title="Actions">Actions</div>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <template for:each={paginatedData} for:item="flow">
                                <tr key={flow.id} class="slds-hint-parent">
                                    <td data-label="Select">
                                        <div class="slds-text-align_center">
                                            <lightning-input
                                                type="checkbox"
                                                data-id={flow.id}
                                                onchange={handleRowSelection}
                                                checked={flow.isSelected}
                                                variant="label-hidden"
                                                label="Select Row"
                                            ></lightning-input>
                                        </div>
                                    </td>
                                    <td data-label="Flow Name">
                                        <div class="slds-truncate" title={flow.flowLabel}>{flow.flowLabel}</div>
                                    </td>
                                    <td data-label="Version">
                                        <div class="slds-text-align_center">
                                            <template if:true={flow.flowVersion}>
                                                v{flow.flowVersion}
                                            </template>
                                            <template if:false={flow.flowVersion}>
                                                -
                                            </template>
                                        </div>
                                    </td>
                                    <td data-label="Status">
                                        <div class="slds-text-align_center">
                                            <span class={flow.statusClass}>{flow.status}</span>
                                        </div>
                                    </td>
                                    <td data-label="Score">
                                        <div class="slds-text-align_center">
                                            <template if:true={flow.score}>
                                                {flow.score}
                                            </template>
                                        </div>
                                    </td>
                                    <td data-label="Last Analyzed">
                                        <div class="slds-truncate">
                                            <template if:true={flow.lastAnalyzed}>
                                                <lightning-formatted-date-time
                                                    value={flow.lastAnalyzed}
                                                    year="numeric"
                                                    month="short"
                                                    day="2-digit"
                                                    hour="2-digit"
                                                    minute="2-digit"
                                                ></lightning-formatted-date-time>
                                            </template>
                                        </div>
                                    </td>
                                    <td data-label="Actions">
                                        <div class="slds-text-align_center">
                                            <lightning-button-group>
                                                <lightning-button
                                                    label="Run Analysis"
                                                    icon-name="utility:refresh"
                                                    variant="brand"
                                                    onclick={handleRunAnalysis}
                                                    data-id={flow.id}
                                                ></lightning-button>
                                                <lightning-button
                                                    label="View"
                                                    icon-name="utility:preview"
                                                    variant="neutral"
                                                    onclick={handleViewAnalysis}
                                                    data-id={flow.id}
                                                ></lightning-button>
                                                <lightning-button
                                                    label="Update Flow"
                                                    icon-name="utility:check"
                                                    variant="neutral"
                                                    onclick={handleUpdateFlow}
                                                    data-id={flow.id}
                                                    title="Refresh flow metadata and version"
                                                ></lightning-button>
                                                <lightning-button
                                                    label="Delete"
                                                    icon-name="utility:delete"
                                                    variant="destructive"
                                                    onclick={handleDeleteSingle}
                                                    data-id={flow.id}
                                                ></lightning-button>
                                            </lightning-button-group>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination Controls -->
                <div class="slds-m-top_small">
                    <div class="slds-float_right">
                            <lightning-button-group>
                                <lightning-button
                                    icon-name="utility:chevronleft"
                                    variant="neutral"
                                    onclick={handlePreviousPage}
                                    disabled={isFirstPage}
                                    title="Previous"
                                ></lightning-button>
                                <lightning-button
                                    label={pageLabel}
                                    variant="neutral"
                                    disabled
                                ></lightning-button>
                                <lightning-button
                                    icon-name="utility:chevronright"
                                    variant="neutral"
                                    onclick={handleNextPage}
                                    disabled={isLastPage}
                                    title="Next"
                                ></lightning-button>
                            </lightning-button-group>
                        </div>
                </div>
            </template>

            <template if:false={hasFlows}>
                <div class="slds-text-align_center slds-m-vertical_large">
                    <lightning-icon
                        icon-name="utility:search"
                        size="large"
                        alternative-text="No results"
                    ></lightning-icon>
                    <p class="slds-m-top_small">No flow analyses found. Click "Fetch All Flows" to get started.</p>
                </div>
            </template>
        </div>
    </lightning-card>

    <!-- Detail Modal -->
    <template if:true={showDetailModal}>
        <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open slds-modal_large">
            <div class="slds-modal__container" style="max-width: 90%; width: 1200px;">
                <!-- Modal Header -->
                <header class="slds-modal__header" style="background: linear-gradient(135deg, #0176d3 0%, #1589ee 100%); color: white;">
                    <button
                        class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse"
                        title="Close"
                        onclick={handleCloseModal}
                    >
                        <lightning-icon icon-name="utility:close" size="small" alternative-text="Close" class="slds-icon-text-default"></lightning-icon>
                        <span class="slds-assistive-text">Close</span>
                    </button>
                    <h2 class="slds-text-heading_medium" style="color: white;">
                        <lightning-icon icon-name="utility:flow" size="small" class="slds-m-right_x-small" style="fill: white;"></lightning-icon>
                        {selectedFlow.flowLabel}
                    </h2>
                </header>

                <!-- Modal Body -->
                <div class="slds-modal__content" style="padding: 0; max-height: 70vh; overflow-y: auto;">
                    <!-- Summary Header -->
                    <div style="background: #f3f3f3; padding: 20px; border-bottom: 2px solid #e0e0e0;">
                        <div class="slds-grid slds-gutters slds-wrap">
                            <div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-4">
                                <div class="analysis-detail-card">
                                    <div class="analysis-detail-label">API Name</div>
                                    <div class="analysis-detail-value">{selectedFlow.flowApiName}</div>
                                </div>
                            </div>
                            <div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-4">
                                <div class="analysis-detail-card">
                                    <div class="analysis-detail-label">Status</div>
                                    <div class="analysis-detail-value">
                                        <span class={selectedFlow.statusClass}>{selectedFlow.status}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-4">
                                <div class="analysis-detail-card">
                                    <div class="analysis-detail-label">Overall Score</div>
                                    <div class="analysis-detail-value analysis-score-value">
                                        {selectedFlow.score}%
                                    </div>
                                </div>
                            </div>
                            <div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-4">
                                <div class="analysis-detail-card">
                                    <div class="analysis-detail-label">Flow Version</div>
                                    <div class="analysis-detail-value">v{selectedFlow.flowVersion}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Analysis Report Content -->
                    <div class="slds-p-around_medium analysis-report-content" lwc:dom="manual"></div>
                </div>

                <!-- Modal Footer -->
                <footer class="slds-modal__footer" style="background: #f9f9f9; border-top: 2px solid #e0e0e0;">
                    <lightning-button
                        label="Export to PDF"
                        icon-name="utility:download"
                        onclick={handleExportPDF}
                        variant="brand"
                        class="slds-m-right_small"
                    ></lightning-button>
                    <lightning-button label="Close" onclick={handleCloseModal} variant="neutral"></lightning-button>
                </footer>
            </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open"></div>
    </template>

    <!-- Fancy Loading Modal for Einstein Analysis -->
    <template if:true={isAnalyzing}>
        <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open">
            <div class="slds-modal__container" style="max-width: 600px;">
                <div class="slds-modal__content slds-p-around_large" style="text-align: center;">
                    <!-- Fun Animation -->
                    <div class="analysis-animation">
                        <lightning-icon
                            icon-name="utility:einstein"
                            size="large"
                            class="einstein-icon"
                        ></lightning-icon>
                        <div class="loading-dots">
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                        </div>
                    </div>

                    <!-- Dynamic Messages -->
                    <h2 class="slds-text-heading_medium slds-m-top_large slds-m-bottom_small">
                        {loadingMessage}
                    </h2>
                    <p class="slds-text-body_regular slds-text-color_weak">
                        {loadingSubMessage}
                    </p>

                    <!-- Progress Bar -->
                    <div class="slds-m-top_medium">
                        <lightning-progress-bar
                            value={analysisProgress}
                            variant="circular"
                        ></lightning-progress-bar>
                    </div>

                    <!-- Fun Tip -->
                    <div class="slds-box slds-theme_shade slds-m-top_large" style="text-align: left;">
                        <p class="slds-text-body_small">
                            <lightning-icon icon-name="utility:info" size="x-small"></lightning-icon>
                            <strong>Did you know?</strong> {funTip}
                        </p>
                    </div>
                </div>
            </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open"></div>
    </template>

    <!-- Help Modal -->
    <template if:true={showHelpModal}>
        <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open slds-modal_large">
            <div class="slds-modal__container">
                <!-- Modal Header -->
                <header class="slds-modal__header">
                    <button
                        class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse"
                        title="Close"
                        onclick={handleCloseHelp}
                    >
                        <lightning-icon icon-name="utility:close" size="small" alternative-text="Close"></lightning-icon>
                        <span class="slds-assistive-text">Close</span>
                    </button>
                    <h2 class="slds-text-heading_medium">
                        <lightning-icon icon-name="utility:info" size="small" class="slds-m-right_x-small"></lightning-icon>
                        Flow AI Audit - Quick Start Guide
                    </h2>
                </header>

                <!-- Modal Body -->
                <div class="slds-modal__content slds-p-around_medium">

                    <!-- Prerequisites Alert -->
                    <div class="slds-box slds-theme_warning slds-m-bottom_medium" style="border-left: 4px solid #fe9339;">
                        <h3 class="slds-text-heading_small slds-m-bottom_small">
                            <lightning-icon icon-name="utility:warning" size="x-small"></lightning-icon>
                            ‚ö†Ô∏è One-Time Setup Required
                        </h3>
                        <p class="slds-text-body_regular">
                            <strong>Before using this dashboard</strong>, you must complete the Tooling API and Einstein configuration below.
                            This only needs to be done once per org. Setup takes approximately 15-20 minutes.
                        </p>
                    </div>

                    <!-- Lightning Page Activation Alert -->
                    <div class="slds-box slds-theme_info slds-m-bottom_medium" style="border-left: 4px solid #0176d3;">
                        <h3 class="slds-text-heading_small slds-m-bottom_small">
                            <lightning-icon icon-name="utility:desktop" size="x-small"></lightning-icon>
                            üñ•Ô∏è Activate Lightning Page
                        </h3>
                        <p class="slds-text-body_regular slds-m-bottom_x-small">
                            <strong>Important:</strong> After deployment, you must activate the Lightning page for users to see the Flow AI Audit tab.
                        </p>
                        <ol class="slds-list_ordered slds-m-left_large slds-text-body_small">
                            <li>Setup ‚Üí User Interface ‚Üí Lightning App Builder</li>
                            <li>Find and open <strong>Flow_AI_Audit_Dashboard</strong></li>
                            <li>Click <strong>Activation</strong> button (top right)</li>
                            <li>Under "Lightning Experience", click <strong>Assign as Org Default</strong> or assign to specific apps</li>
                            <li>Under "Profiles", select <strong>System Administrator</strong> (and other profiles as needed)</li>
                            <li>Click <strong>Save</strong></li>
                        </ol>
                        <p class="slds-text-body_small slds-text-color_weak slds-m-top_x-small">
                            üí° Without activation, users will not see the Flow AI Audit tab in their navigation.
                        </p>
                    </div>

                    <!-- Setup Instructions -->
                    <div class="slds-box slds-m-bottom_medium" style="background: #fef8e8; border-left: 4px solid #0176d3;">
                        <h3 class="slds-text-heading_small slds-m-bottom_small">
                            <lightning-icon icon-name="utility:setup" size="x-small"></lightning-icon>
                            üîß Required Setup Steps
                        </h3>

                        <!-- Tooling API Setup -->
                        <div class="slds-m-bottom_medium">
                            <h4 class="slds-text-heading_x-small slds-m-bottom_small" style="color: #0176d3;">
                                A. Tooling API Setup (10 minutes)
                            </h4>
                            <p class="slds-text-body_small slds-m-bottom_x-small"><strong>Why needed:</strong> Allows the dashboard to fetch flow metadata for analysis.</p>

                            <ol class="slds-list_ordered slds-m-left_large">
                                <li class="slds-m-bottom_small">
                                    <strong>Create Connected App:</strong>
                                    <ul class="slds-list_dotted slds-m-left_medium">
                                        <li>Setup ‚Üí Apps ‚Üí App Manager ‚Üí New Connected App</li>
                                        <li>Name: <code>Tooling_API_Access</code></li>
                                        <li>Enable OAuth Settings ‚úÖ</li>
                                        <li>Callback URL: <code>https://YOUR_DOMAIN.my.salesforce.com/services/authcallback/ToolingAPILoopback</code></li>
                                        <li>OAuth Scopes: api, refresh_token, id</li>
                                        <li>Save and copy Consumer Key & Secret</li>
                                    </ul>
                                </li>
                                <li class="slds-m-bottom_small">
                                    <strong>Create Auth Provider:</strong>
                                    <ul class="slds-list_dotted slds-m-left_medium">
                                        <li>Setup ‚Üí Identity ‚Üí Auth. Providers ‚Üí New</li>
                                        <li>Provider Type: Salesforce</li>
                                        <li>Name: <code>ToolingAPILoopback</code></li>
                                        <li>Paste Consumer Key & Secret from step 1</li>
                                        <li>Default Scopes: <code>api refresh_token</code></li>
                                    </ul>
                                </li>
                                <li class="slds-m-bottom_small">
                                    <strong>Create Named Credential:</strong>
                                    <ul class="slds-list_dotted slds-m-left_medium">
                                        <li>Setup ‚Üí Security ‚Üí Named Credentials ‚Üí New Legacy</li>
                                        <li>Label & Name: <code>Salesforce_Tooling_API</code></li>
                                        <li>URL: <code>https://YOUR_DOMAIN.my.salesforce.com</code></li>
                                        <li>Identity Type: Named Principal</li>
                                        <li>Auth Protocol: OAuth 2.0</li>
                                        <li>Auth Provider: ToolingAPILoopback</li>
                                        <li>Scope: <code>api refresh_token</code></li>
                                        <li>Check "Start Authentication Flow on Save" ‚úÖ</li>
                                        <li>Save ‚Üí Click Allow ‚Üí Verify "Authenticated" status</li>
                                    </ul>
                                    <div class="slds-box slds-theme_shade slds-m-top_x-small slds-m-left_medium" style="border-left: 3px solid #fe9339;">
                                        <p class="slds-text-body_small"><strong>‚ö†Ô∏è Troubleshooting OAuth Authentication:</strong></p>
                                        <ul class="slds-list_dotted slds-m-left_small slds-text-body_small">
                                            <li><strong>Use Incognito/Private Window:</strong> Named Credential OAuth works best in an incognito browser window to avoid cookie conflicts.</li>
                                            <li><strong>Token Mismatch Error:</strong> If you see this error, refresh the page and try again.</li>
                                            <li><strong>Multiple Login Prompts:</strong> You may be prompted to log in multiple times (this is expected when setting up OAuth for the same org):
                                                <ol class="slds-list_ordered slds-m-left_small">
                                                    <li>First login prompt ‚Üí Log in</li>
                                                    <li>Authorization screen ‚Üí Click Allow</li>
                                                    <li>Second login prompt may appear ‚Üí Log in again</li>
                                                    <li>Final authorization ‚Üí Click Allow</li>
                                                </ol>
                                            </li>
                                            <li>This behavior occurs because we're setting up an Auth Provider that points back to the same org (loopback configuration).</li>
                                        </ul>
                                    </div>
                                </li>
                                <li>
                                    <strong>Verify Setup:</strong>
                                    <ul class="slds-list_dotted slds-m-left_medium">
                                        <li>Open Developer Console</li>
                                        <li>Run: <code>HttpRequest req = new HttpRequest(); req.setEndpoint('callout:Salesforce_Tooling_API/services/data/v65.0/tooling/query?q=SELECT+Id+FROM+Flow+LIMIT+1'); req.setMethod('GET'); Http http = new Http(); HttpResponse res = http.send(req); System.debug('Status: ' + res.getStatusCode());</code></li>
                                        <li>Expected: Status: 200 ‚úÖ</li>
                                    </ul>
                                </li>
                            </ol>
                        </div>

                        <!-- Einstein Setup -->
                        <div class="slds-m-bottom_medium">
                            <h4 class="slds-text-heading_x-small slds-m-bottom_small" style="color: #0176d3;">
                                B. Einstein Configuration (5 minutes)
                            </h4>
                            <p class="slds-text-body_small slds-m-bottom_x-small"><strong>Why needed:</strong> Powers the AI analysis of your flows.</p>

                            <ol class="slds-list_ordered slds-m-left_large">
                                <li class="slds-m-bottom_small">
                                    <strong>Activate Prompt Template:</strong>
                                    <ul class="slds-list_dotted slds-m-left_medium">
                                        <li>Setup ‚Üí Einstein ‚Üí Prompt Templates</li>
                                        <li>Find: <code>FlowAIAudit</code></li>
                                        <li>Click Edit ‚Üí Verify settings:</li>
                                        <li>&nbsp;&nbsp;- Model: Claude Sonnet 3.7 or 4</li>
                                        <li>&nbsp;&nbsp;- Response Format: JSON</li>
                                        <li>&nbsp;&nbsp;- Prompt evaluates 12 categories with 4-tier severity</li>
                                        <li>Click Save ‚Üí Click Activate ‚úÖ</li>
                                    </ul>
                                </li>
                                <li>
                                    <strong>Verify Einstein License:</strong>
                                    <ul class="slds-list_dotted slds-m-left_medium">
                                        <li>Ensure you have Einstein 1 license</li>
                                        <li>Check: Setup ‚Üí Company Information ‚Üí Features</li>
                                        <li>Must see "Prompt Builder" enabled</li>
                                    </ul>
                                </li>
                            </ol>
                        </div>

                        <!-- Remote Site Setting -->
                        <div>
                            <h4 class="slds-text-heading_x-small slds-m-bottom_small" style="color: #0176d3;">
                                C. Remote Site Setting (Optional - if needed)
                            </h4>
                            <p class="slds-text-body_small slds-m-bottom_x-small">Only required if you see "Unauthorized endpoint" errors.</p>

                            <ol class="slds-list_ordered slds-m-left_large">
                                <li>
                                    <ul class="slds-list_dotted slds-m-left_medium">
                                        <li>Setup ‚Üí Security ‚Üí Remote Site Settings</li>
                                        <li>New Remote Site</li>
                                        <li>Name: <code>Salesforce_Instance</code></li>
                                        <li>URL: <code>https://YOUR_DOMAIN.my.salesforce.com</code></li>
                                        <li>Active: ‚úÖ Checked</li>
                                    </ul>
                                </li>
                            </ol>
                        </div>

                        <!-- Help Link -->
                        <div class="slds-m-top_medium slds-text-align_center">
                            <p class="slds-text-body_small">
                                <lightning-icon icon-name="utility:help" size="xx-small"></lightning-icon>
                                Need detailed setup instructions? See:
                                <a href="https://github.com/pasumartyshiva/FlowAIAudit/blob/main/docs/TOOLING_API_SETUP.md" target="_blank">Complete Setup Guide</a>
                            </p>
                        </div>
                    </div>

                    <hr class="slds-m-vertical_medium" />

                    <!-- Step 1 -->
                    <div class="slds-box slds-theme_shade slds-m-bottom_medium">
                        <h3 class="slds-text-heading_small slds-m-bottom_small">
                            <span class="help-step-number">1</span>
                            Fetch Your Flows
                        </h3>
                        <p class="slds-text-body_regular slds-m-bottom_x-small">
                            Click <strong>"Fetch All Flows"</strong> to retrieve all active flows from your org.
                        </p>
                        <p class="slds-text-body_small slds-text-color_weak">
                            üí° This creates a record for each flow but doesn't run the AI analysis yet.
                        </p>
                    </div>

                    <!-- Step 2 -->
                    <div class="slds-box slds-theme_shade slds-m-bottom_medium">
                        <h3 class="slds-text-heading_small slds-m-bottom_small">
                            <span class="help-step-number">2</span>
                            Run AI Analysis
                        </h3>
                        <p class="slds-text-body_regular slds-m-bottom_x-small">
                            <strong>Single Flow:</strong> Click <strong>"Run Analysis"</strong> in any flow's action menu.
                        </p>
                        <p class="slds-text-body_regular slds-m-bottom_x-small">
                            <strong>Bulk Analysis:</strong> Select up to 5 flows using checkboxes, then click <strong>"Analyze Selected (Max 5)"</strong> button.
                        </p>
                        <p class="slds-text-body_small slds-text-color_weak">
                            üí° Einstein analyzes 12 best practice categories including error handling, performance, and maintainability.
                        </p>
                        <p class="slds-text-body_small slds-text-color_weak">
                            ‚ö° Bulk analysis processes flows sequentially to avoid system overload. Limit: 5 flows at a time.
                        </p>
                    </div>

                    <!-- Step 3 -->
                    <div class="slds-box slds-theme_shade slds-m-bottom_medium">
                        <h3 class="slds-text-heading_small slds-m-bottom_small">
                            <span class="help-step-number">3</span>
                            Review Results
                        </h3>
                        <p class="slds-text-body_regular slds-m-bottom_x-small">
                            Click <strong>"View"</strong> to see detailed analysis with recommendations.
                        </p>
                        <p class="slds-text-body_small slds-text-color_weak">
                            üí° Results are color-coded: <span class="slds-text-color_success">Pass (green)</span>,
                            <span class="slds-text-color_warning">Needs Work (orange)</span>,
                            <span class="slds-text-color_error">Fail (red)</span>
                        </p>
                    </div>

                    <!-- Step 4 -->
                    <div class="slds-box slds-theme_shade slds-m-bottom_medium">
                        <h3 class="slds-text-heading_small slds-m-bottom_small">
                            <span class="help-step-number">4</span>
                            Export to PDF
                        </h3>
                        <p class="slds-text-body_regular slds-m-bottom_x-small">
                            In the analysis view, click <strong>"Export to PDF"</strong> to download a professional report.
                        </p>
                        <p class="slds-text-body_small slds-text-color_weak">
                            üí° Perfect for sharing with stakeholders or documenting compliance.
                        </p>
                    </div>

                    <!-- Step 5 -->
                    <div class="slds-box slds-theme_shade slds-m-bottom_medium" style="border-left: 4px solid #06a59a;">
                        <h3 class="slds-text-heading_small slds-m-bottom_small">
                            <span class="help-step-number">5</span>
                            Create Executive Reports (Optional)
                        </h3>
                        <p class="slds-text-body_regular slds-m-bottom_small">
                            For <strong>leadership visibility</strong>, create native Salesforce reports and dashboards:
                        </p>

                        <div class="slds-m-bottom_small">
                            <p class="slds-text-body_small slds-text-color_default slds-m-bottom_x-small">
                                <strong>üìä Why Use Reports?</strong>
                            </p>
                            <ul class="slds-list_dotted slds-m-left_medium slds-text-body_small">
                                <li>‚úÖ Real-time data (always current)</li>
                                <li>‚úÖ Schedule automated email delivery</li>
                                <li>‚úÖ Build executive dashboards</li>
                                <li>‚úÖ Export to Excel/PDF anytime</li>
                                <li>‚úÖ Track trends and KPIs</li>
                            </ul>
                        </div>

                        <div class="slds-m-bottom_small">
                            <p class="slds-text-body_small slds-text-color_default slds-m-bottom_x-small">
                                <strong>üéØ Quick Start (3 minutes per report):</strong>
                            </p>
                            <ol class="slds-list_ordered slds-m-left_large slds-text-body_small">
                                <li>Reports tab ‚Üí New Report</li>
                                <li>Select <strong>"Flow Analysis Reports"</strong> type</li>
                                <li>Choose format (Summary/Tabular)</li>
                                <li>Add columns: Flow Label, Overall Score, Overall Status</li>
                                <li>Add filters: Status = Pass, Needs Work, or Fail</li>
                                <li>Add chart (optional): Bar/Line chart</li>
                                <li>Save to "Flow Analysis Reports" folder</li>
                            </ol>
                        </div>

                        <div class="slds-m-bottom_small">
                            <p class="slds-text-body_small slds-text-color_default slds-m-bottom_x-small">
                                <strong>üìà Sample Reports to Create:</strong>
                            </p>
                            <ul class="slds-list_dotted slds-m-left_medium slds-text-body_small">
                                <li><strong>Flow Analysis Summary</strong> - Overview with PASS/NEEDS WORK/FAIL chart</li>
                                <li><strong>Flows Needing Attention</strong> - List flows scoring &lt; 70%</li>
                                <li><strong>Flow Score Trends</strong> - Track improvements over time</li>
                            </ul>
                        </div>

                        <div class="slds-m-bottom_small">
                            <p class="slds-text-body_small slds-text-color_default slds-m-bottom_x-small">
                                <strong>üé® Build Executive Dashboard:</strong>
                            </p>
                            <ol class="slds-list_ordered slds-m-left_large slds-text-body_small">
                                <li>Dashboards tab ‚Üí New Dashboard</li>
                                <li>Add your reports as components</li>
                                <li>Set refresh schedule (daily/weekly)</li>
                                <li>Share with leadership team</li>
                            </ol>
                        </div>

                        <p class="slds-text-body_small slds-text-color_weak">
                            üí° <strong>Detailed Guide:</strong> See repository file <code>REPORTS_SETUP_GUIDE.md</code> for step-by-step instructions, SOQL queries, and dashboard design tips.
                        </p>
                    </div>

                    <!-- Additional Features -->
                    <div class="slds-box slds-m-bottom_medium" style="background: #e8f4ff; border-left: 4px solid #0176d3;">
                        <h3 class="slds-text-heading_small slds-m-bottom_small">
                            <lightning-icon icon-name="utility:knowledge_base" size="x-small"></lightning-icon>
                            Additional Features
                        </h3>
                        <ul class="slds-list_dotted">
                            <li><strong>Bulk Analysis:</strong> Select up to 5 flows and analyze them with one click - faster than analyzing one by one!</li>
                            <li><strong>Update Flow:</strong> Refresh flow metadata when a new version is published (clears old analysis)</li>
                            <li><strong>Filter & Search:</strong> Use the dropdown and search bar to find specific flows</li>
                            <li><strong>Bulk Delete:</strong> Select multiple rows and delete them together</li>
                            <li><strong>Auto-Refresh:</strong> Status updates automatically while analysis runs</li>
                        </ul>
                    </div>

                    <!-- Understanding Results -->
                    <div class="slds-box slds-m-bottom_medium" style="background: #fef8e8; border-left: 4px solid #fe9339;">
                        <h3 class="slds-text-heading_small slds-m-bottom_small">
                            <lightning-icon icon-name="utility:metrics" size="x-small"></lightning-icon>
                            Understanding Analysis Results
                        </h3>
                        <table class="slds-table slds-table_bordered slds-table_cell-buffer">
                            <thead>
                                <tr>
                                    <th scope="col">Status</th>
                                    <th scope="col">Score Range</th>
                                    <th scope="col">Meaning</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><span class="slds-text-color_success">Pass</span></td>
                                    <td>70-100%</td>
                                    <td>Good - Meets most best practices</td>
                                </tr>
                                <tr>
                                    <td><span class="slds-text-color_warning">Needs Work</span></td>
                                    <td>40-69%</td>
                                    <td>Fair - Notable improvements recommended</td>
                                </tr>
                                <tr>
                                    <td><span class="slds-text-color_error">Fail</span></td>
                                    <td>0-39%</td>
                                    <td>Critical - Significant issues require attention</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Tips -->
                    <div class="slds-box slds-m-bottom_medium" style="background: #f3f2f2;">
                        <h3 class="slds-text-heading_small slds-m-bottom_small">
                            <lightning-icon icon-name="utility:announcement" size="x-small"></lightning-icon>
                            üí° Pro Tips
                        </h3>
                        <ul class="slds-list_dotted">
                            <li>Run analysis during off-peak hours for faster results</li>
                            <li>Re-run analysis after making fixes to track improvements</li>
                            <li>Use filters to focus on flows that need attention (Fail/Needs Work)</li>
                            <li>When flows are updated, use "Update Flow" to clear old analysis and re-analyze</li>
                            <li>Export PDFs for audit trails and compliance documentation</li>
                            <li>Start with 5-10 simple flows before analyzing complex ones</li>
                        </ul>
                    </div>

                    <!-- Troubleshooting -->
                    <div class="slds-box" style="background: #fee; border-left: 4px solid #c23934;">
                        <h3 class="slds-text-heading_small slds-m-bottom_small">
                            <lightning-icon icon-name="utility:error" size="x-small"></lightning-icon>
                            üîß Common Issues & Solutions
                        </h3>

                        <div class="slds-m-bottom_small">
                            <p class="slds-text-body_small"><strong>‚ùå "No flows showing in dropdown"</strong></p>
                            <ul class="slds-list_dotted slds-m-left_medium">
                                <li>Check Named Credential status: Setup ‚Üí Named Credentials ‚Üí Verify "Authenticated"</li>
                                <li>Re-authenticate if needed: Edit ‚Üí Check "Start Auth Flow" ‚Üí Save</li>
                                <li>Verify you have active flows: Setup ‚Üí Flows</li>
                            </ul>
                        </div>

                        <div class="slds-m-bottom_small">
                            <p class="slds-text-body_small"><strong>‚ùå "Analysis stuck at Processing"</strong></p>
                            <ul class="slds-list_dotted slds-m-left_medium">
                                <li>Check Einstein limits: Setup ‚Üí Einstein ‚Üí Usage</li>
                                <li>Verify prompt template is Active: Setup ‚Üí Einstein ‚Üí Prompt Templates</li>
                                <li>Check Debug Logs for errors: Setup ‚Üí Debug Logs</li>
                            </ul>
                        </div>

                        <div class="slds-m-bottom_small">
                            <p class="slds-text-body_small"><strong>‚ùå "Unauthorized endpoint" error</strong></p>
                            <ul class="slds-list_dotted slds-m-left_medium">
                                <li>Add Remote Site Setting (see Setup section C above)</li>
                                <li>Setup ‚Üí Security ‚Üí Remote Site Settings ‚Üí Add your org URL</li>
                            </ul>
                        </div>

                        <div class="slds-m-bottom_small">
                            <p class="slds-text-body_small"><strong>‚ùå "Insufficient Privileges"</strong></p>
                            <ul class="slds-list_dotted slds-m-left_medium">
                                <li>Assign permission set via CLI: <code>sf org assign permset --name Flow_AI_Audit_Dashboard_Access</code></li>
                                <li>Or manually: Setup ‚Üí Permission Sets ‚Üí Assign to your user</li>
                            </ul>
                        </div>

                        <div>
                            <p class="slds-text-body_small"><strong>‚ùå "PDF export not working"</strong></p>
                            <ul class="slds-list_dotted slds-m-left_medium">
                                <li>Check pop-up blocker settings in your browser</li>
                                <li>Allow pop-ups for your Salesforce domain</li>
                                <li>Try Chrome browser (recommended)</li>
                            </ul>
                        </div>

                        <div class="slds-m-top_small slds-text-align_center">
                            <p class="slds-text-body_small">
                                Still having issues?
                                <a href="https://github.com/pasumartyshiva/FlowAIAudit/issues" target="_blank">Report on GitHub</a> |
                                <a href="https://github.com/pasumartyshiva/FlowAIAudit/blob/main/QUICK_START.md" target="_blank">Full Quick Start Guide</a>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Modal Footer -->
                <footer class="slds-modal__footer">
                    <lightning-button label="Got It!" onclick={handleCloseHelp} variant="brand"></lightning-button>
                </footer>
            </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open"></div>
    </template>
</template>